---
layout: post
title: "CBIR Project"
description: "Notes"
categories: [Project]
tags: [Python]
redirect_from:
  - /2019/09/26/
---

# CBIR Project    

## Introduction  

CBIR是一个基于内容的以图搜图系统，入学初师姐让我做个小项目练练手，说是小项目实际上做了整整一周，中间还通了一个宵，遇到的坑太多，待我慢慢道来。  

## 特征提取  

CBIR可以分为两个部分，第一个部分是将数据库的特征提取，这里由于我太菜所以没有fine-tune，直接拿着VGG16在ImageNet上预训练的结果就往上硬怼了，一开始怼的方式不佳，直接提取了倒数第二个特征层，结果提了个卷积层的参数，1个G的图片硬生生提取出了12个G的特征，把服务器的硬盘都给提满了。最骚的是我还不要脸的去问师姐扩硬盘……师姐在满足了我这个无理要求后顺便告诉我，特征也就是几百M，这时候我才发现提的特征是错的，遂改正至分类器的倒数第二层。由于我不会批量提取，只能暴殄天物的用实验室的1080Ti显存的十分之一不到来一个一个的提取，一共提取了20个小时才提取完，我寻思要是以10为批量进行提取，也就是两个小时就提取完了，不过一旦开始了我又不舍得听，遂等待。  

## 图片查询  

CBIR的另一个部分是图片的查询，也就是把一个新图片放进去，提取其特征与提取的特征相比较，sort一下打印出最相似的几张图片。这里看似很简单，但是由于我实在是水平不精，连python字典对键排序都不会，百度了一大圈才找到处理方式，所以花费了好久的时间才完成这一任务。此外，我把特征都存到了h5py文件里，提取特征的时候从网上抄代码，把一行压缩维度的代码也抄上了，这就导致最后的特征规模是(n*4096,4096)，而n是提取的图片数量，而本来应该是(n,4096,4096)，这就导致维度错误而无法进行特征的比较，我又用了好久才找出问题所在，遂改正。  

## 性能评价  

这里使用mAP作为性能评价的标准，我一开始对mAP的理解出现了偏差，这都是因为那张最出名的mAP计算图例，我错误的认为要一直找，直到把所有的正确图片都找出来为止，而caltech-256数据集里面一个类里面的图片有几百张，同一类里面的有的图片相互压根就不像，这就导致要找好久才能找到所有的图片，最后的mAP只有0.37，非常惨淡。  
事实上，我们只需要设定一个特定的数值，比如50或者100，输出查询的该数值个结果，比如50张或者100张最像的图片，之后计算这些里面查找正确的图片的准确率，取平均即可，这种方法还是比较合适的，最后的mAP有0.6多，经师姐鉴定还是不错的（不知道是不是安慰奖）。反过来想一想，全找出来的mAP还有0.37，相当不错嘛:)  

## 总结  

做了一星期的项目像是把我扒了一层皮，不断的试错，debug，重新整理思路去github寻找新的代码，这都是我以前从来没经历过的。大晚上一个人坐着生无可恋怀疑人生的感觉是真的不想再体会第二遍，不过看着基本上全是自己敲的代码能够跑起来并获得不错的结果，自己的收获还是很高的，我觉得这个经历本身远远比这个项目更为重要。  

项目已经放在我的Github里啦，这里是[传送门](https://github.com/JustinYuu/CBIR_pytorch)  


---
本博客支持disqus实时评论功能，如有错误或者建议，欢迎在下方评论区提出，共同探讨。  
